<!--
2. brancher les fils restants pour les 3 options
3. Sortir code python en externe
1. Optimisation chargement dictionnaire: découpage, compression
4. améliorer UI: découper "deviner" en 2 fonctions
-->

<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
  <link rel="stylesheet" type="text/css" href="https://unpkg.com/fomantic-ui@2.8.8/dist/semantic.min.css">
  <script src="https://unpkg.com/fomantic-ui@2.8.8/dist/semantic.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.21.0/full/pyodide.js"></script>
  <script>
    var results = new Array(0,0,0,0,0);
    var n_total_char = 5;
    var lang = 'fr';

    function setColor(n_word, n_char) {
      var base = Math.pow(3, n_char);
      var current_state = Math.floor(results[n_word] / base) % 3;
      var property = document.getElementById('button_'+n_word+'_'+n_char);
      if (current_state == 2) {
        property.setAttribute('class', 'ui button'); // color if 0
        results[n_word] -= 2*base;
      } else if (current_state == 0) {
        property.setAttribute('class', 'ui orange button'); // color if 1
        results[n_word] += base;
      } else {
        property.setAttribute('class', 'ui green button'); // color if 2
        results[n_word] += base;        
      }
    }

    function updateButtonsContent(n_word) {
      var input_word = document.getElementById('try_'+n_word).value;
      if (input_word.length == 0) {
        for (let c = 0; c < 9; c++) {
          var property = document.getElementById('button_'+n_word+'_'+c);
          property.innerHTML = '-';
          property.setAttribute('class', 'ui disabled button');
        }
      } else {
        for (let c = 0; c < 9; c++) {
          var property = document.getElementById('button_'+n_word+'_'+c);
          property.innerHTML = (c < input_word.length) ? input_word.charAt(c) : '-';
          property.setAttribute('class', 'ui button');
        }
      }
    }

    function setNbChars(new_lang, new_nb_chars) {
      n_total_char = new_nb_chars;
      lang = new_lang;
      for (let i_word = 0; i_word < 5; i_word++) {
        document.getElementById('try_'+i_word).setAttribute('maxlength', n_total_char);
        for (let i_char = 0; i_char < 9; i_char++) {
          document.getElementById('button_'+i_word+'_'+i_char).hidden = (i_char >= n_total_char);
          if (i_char >= n_total_char) {
            document.getElementById('button_'+i_word+'_'+i_char).style.display = 'none';
          } else {
            document.getElementById('button_'+i_word+'_'+i_char).style = '';
          }
        }
      }

      for (let i_lang = 0; i_lang < 2; i_lang++) {
        s_lang = ['fr', 'en'][i_lang];
        for (let i_chars = 5; i_chars < 10; i_chars++) {
          if (new_lang == s_lang && new_nb_chars == i_chars) {
            document.getElementById(s_lang+i_chars).setAttribute('class', "ui grey basic button");
          } else {
            document.getElementById(s_lang+i_chars).setAttribute('class', "ui basic button");
          }
        }
      }

      changeLangPython();
    }

  </script>
</head>
<body>
<div class="ui container">

<!-- Titre -->

  <div class="ui text">
    <div class="ui section hidden divider"></div>
    <h1 class="ui massive centered header">Wordle Solver</h1>
  </div>

<!-- Options -->

  <div class="ui section hidden divider"></div>
  <div class="ui form">
    <div class="field">
      <label>Langue et nombre de lettres</label>
      <div class="ui buttons">
        <button class="ui tertiary button"><i class="fr flag"></i></button>
        <button class="ui grey basic button" id="fr5" onclick="setNbChars('fr', 5)">5</button>
        <button class="ui basic button" id="fr6" onclick="setNbChars('fr', 6)">6</button>
        <button class="ui basic button" id="fr7" onclick="setNbChars('fr', 7)">7</button>
        <button class="ui basic button" id="fr8" onclick="setNbChars('fr', 8)">8</button>
        <button class="ui basic button" id="fr9" onclick="setNbChars('fr', 9)">9</button>
      </div>
      <span style="display:inline-block; width:1em;"></span>
      <div class="ui buttons">
        <button class="ui tertiary button" ><i class="us flag"></i></button>
        <button class="ui basic button" id="en5" onclick="setNbChars('en', 5)">5</button>
        <button class="ui basic button" id="en6" onclick="setNbChars('en', 6)">6</button>
        <button class="ui basic button" id="en7" onclick="setNbChars('en', 7)">7</button>
        <button class="ui basic button" id="en8" onclick="setNbChars('en', 8)">8</button>
        <button class="ui basic button" id="en9" onclick="setNbChars('en', 9)">9</button>
      </div>
    </div>

    <div class="field">
      <label>Avancé</label>
      <div class="three fields">
        <div class="field">
          <div class="ui toggle checkbox">
            <input type="checkbox" id="opt_rare">
            <label>Autorise les mots rares (déconseillé)</label>
          </div>
        </div>
        <div class="field">
          <div class="ui toggle checkbox">
            <input type="checkbox" id="opt_hard">
            <label>Wordle en mode difficile (conseillé pour nytimes)</label>
          </div>
        </div>
        <div class="field">
          <div class="ui toggle checkbox">
            <input type="checkbox" id="opt_best">
            <label>Cherche de meilleures solutions, mais plus lent</label>
          </div>
        </div>
      </div>
    </div>

  </div>


<!-- Mots -->

  <div class="ui section hidden divider"></div>
  <div class="ui grid">
    <div class="three wide column ">
      <div class="ui fluid labeled input">
        <input id="try_0" value="" oninput="updateButtonsContent(0)" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Mot essayé"/>
      </div>
    </div>
    <div class="thirteen wide column ">
      <div class="ui nine big buttons">
        <button class="ui disabled button" id="button_0_0" onclick="setColor(0, 0)" >-</button>
        <button class="ui disabled button" id="button_0_1" onclick="setColor(0, 1)" >-</button>
        <button class="ui disabled button" id="button_0_2" onclick="setColor(0, 2)" >-</button>
        <button class="ui disabled button" id="button_0_3" onclick="setColor(0, 3)" >-</button>
        <button class="ui disabled button" id="button_0_4" onclick="setColor(0, 4)" >-</button>
        <button class="ui disabled button" id="button_0_5" onclick="setColor(0, 5)" style="display: none">-</button>
        <button class="ui disabled button" id="button_0_6" onclick="setColor(0, 6)" style="display: none">-</button>
        <button class="ui disabled button" id="button_0_7" onclick="setColor(0, 7)" style="display: none">-</button>
        <button class="ui disabled button" id="button_0_8" onclick="setColor(0, 8)" style="display: none">-</button>
      </div>
    </div>
  </div>

  <div class="ui grid">
    <div class="three wide column ">
      <div class="ui fluid labeled input">
        <input id="try_1" value="" oninput="updateButtonsContent(1)" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Mot essayé"/>
      </div>
    </div>
    <div class="thirteen wide column ">
      <div class="ui nine big buttons">
        <button class="ui disabled button" id="button_1_0" onclick="setColor(1, 0)" >-</button>
        <button class="ui disabled button" id="button_1_1" onclick="setColor(1, 1)" >-</button>
        <button class="ui disabled button" id="button_1_2" onclick="setColor(1, 2)" >-</button>
        <button class="ui disabled button" id="button_1_3" onclick="setColor(1, 3)" >-</button>
        <button class="ui disabled button" id="button_1_4" onclick="setColor(1, 4)" >-</button>
        <button class="ui disabled button" id="button_1_5" onclick="setColor(1, 5)" style="display: none">-</button>
        <button class="ui disabled button" id="button_1_6" onclick="setColor(1, 6)" style="display: none">-</button>
        <button class="ui disabled button" id="button_1_7" onclick="setColor(1, 7)" style="display: none">-</button>
        <button class="ui disabled button" id="button_1_8" onclick="setColor(1, 8)" style="display: none">-</button>
      </div>
    </div>
  </div>

  <div class="ui grid">
    <div class="three wide column ">
      <div class="ui fluid labeled input">
        <input id="try_2" value="" oninput="updateButtonsContent(2)" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Mot essayé"/>
      </div>
    </div>
    <div class="thirteen wide column ">
      <div class="ui nine big buttons">
        <button class="ui disabled button" id="button_2_0" onclick="setColor(2, 0)" >-</button>
        <button class="ui disabled button" id="button_2_1" onclick="setColor(2, 1)" >-</button>
        <button class="ui disabled button" id="button_2_2" onclick="setColor(2, 2)" >-</button>
        <button class="ui disabled button" id="button_2_3" onclick="setColor(2, 3)" >-</button>
        <button class="ui disabled button" id="button_2_4" onclick="setColor(2, 4)" >-</button>
        <button class="ui disabled button" id="button_2_5" onclick="setColor(2, 5)" style="display: none">-</button>
        <button class="ui disabled button" id="button_2_6" onclick="setColor(2, 6)" style="display: none">-</button>
        <button class="ui disabled button" id="button_2_7" onclick="setColor(2, 7)" style="display: none">-</button>
        <button class="ui disabled button" id="button_2_8" onclick="setColor(2, 8)" style="display: none">-</button>
      </div>
    </div>
  </div>

  <div class="ui grid">
    <div class="three wide column ">
      <div class="ui fluid labeled input">
        <input id="try_3" value="" oninput="updateButtonsContent(3)" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Mot essayé"/>
      </div>
    </div>
    <div class="thirteen wide column ">
      <div class="ui nine big buttons">
        <button class="ui disabled button" id="button_3_0" onclick="setColor(3, 0)" >-</button>
        <button class="ui disabled button" id="button_3_1" onclick="setColor(3, 1)" >-</button>
        <button class="ui disabled button" id="button_3_2" onclick="setColor(3, 2)" >-</button>
        <button class="ui disabled button" id="button_3_3" onclick="setColor(3, 3)" >-</button>
        <button class="ui disabled button" id="button_3_4" onclick="setColor(3, 4)" >-</button>
        <button class="ui disabled button" id="button_3_5" onclick="setColor(3, 5)" style="display: none">-</button>
        <button class="ui disabled button" id="button_3_6" onclick="setColor(3, 6)" style="display: none">-</button>
        <button class="ui disabled button" id="button_3_7" onclick="setColor(3, 7)" style="display: none">-</button>
        <button class="ui disabled button" id="button_3_8" onclick="setColor(3, 8)" style="display: none">-</button>
      </div>
    </div>
  </div>

  <div class="ui grid">
    <div class="three wide column ">
      <div class="ui fluid labeled input">
        <input id="try_4" value="" oninput="updateButtonsContent(4)" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Mot essayé"/>
      </div>
    </div>
    <div class="thirteen wide column ">
      <div class="ui nine big buttons">
        <button class="ui disabled button" id="button_4_0" onclick="setColor(4, 0)" >-</button>
        <button class="ui disabled button" id="button_4_1" onclick="setColor(4, 1)" >-</button>
        <button class="ui disabled button" id="button_4_2" onclick="setColor(4, 2)" >-</button>
        <button class="ui disabled button" id="button_4_3" onclick="setColor(4, 3)" >-</button>
        <button class="ui disabled button" id="button_4_4" onclick="setColor(4, 4)" >-</button>
        <button class="ui disabled button" id="button_4_5" onclick="setColor(4, 5)" style="display: none">-</button>
        <button class="ui disabled button" id="button_4_6" onclick="setColor(4, 6)" style="display: none">-</button>
        <button class="ui disabled button" id="button_4_7" onclick="setColor(4, 7)" style="display: none">-</button>
        <button class="ui disabled button" id="button_4_8" onclick="setColor(4, 8)" style="display: none">-</button>
      </div>
    </div>
  </div>


<!-- Bouton(s) et sortie console -->

  <div class="ui section hidden divider"></div>
  <div class="ui stackable grid">
    <div class="four wide column ">
      <span class="ui grey text" id="guesshint">-</span>
    </div>
    <div class="eight wide column ">
      <button class="fluid ui primary massive button" id="btn_guess" onclick="guess()">Deviner</button>
    </div>
  </div>
  <div class="ui hidden divider"></div>
  
  <div class="ui section hidden divider"></div>
  <div class="ui form">
    <div class="field">
      <label>Sortie console</label>
      <div class="ui fluid disabled input">
        <textarea placeholder="Console log" id="consolelog"></textarea>
      </div>
    </div>
  </div>


</div>
<script>
  const output = document.getElementById("consolelog");
  var hint_output = document.getElementById('guesshint');
  const button_guess = document.getElementById('btn_guess');
  function addToOutput(s) {
    output.value += ">>>" + s + "\n";
  }

  const py_init = `
from pyodide.http import pyfetch
from math import log2, sqrt
import js

max_nb_chars = 10
base = [3**i for i in range(max_nb_chars+1)]
max_combinations_to_try = 200000
min_words = 20
default_freq = 0.001

estimates = []
archives = []

json_fr = 'https://raw.githubusercontent.com/cestpasphoto/wordle_solver_french/main/parsed_fr_dictionary.json'
json_en = 'https://raw.githubusercontent.com/cestpasphoto/wordle_solver_french/main/parsed_en_dictionary.json'
dico_lang = 'fr'
response = await pyfetch(json_fr)
dico = await (response.json())
dico_n = dico[5]
dico_n = {w: p for w,p in dico_n.items() if p >= 0.001} # Mode "top"
dico_n = {w: sqrt(p) for w,p in dico_n.items()} # Mode average
print(js.n_total_char, ': ', len(dico_n))
best_words = ', '.join(sorted(dico_n.keys(), key=lambda x: dico_n[x], reverse=True)[:5])
js.hint_output.innerHTML = f'{len(dico_n)} mot(s) possible(s) dont: {best_words}'
`

  const py_load_lang = `
json_url = json_fr if js.lang == 'fr' else json_en
response = await pyfetch(json_url)
dico = await (response.json())
dico_n = dico[js.n_total_char]
dico_n = {w: p for w,p in dico_n.items() if p >= 0.001} # Mode "top"
dico_n = {w: sqrt(p) for w,p in dico_n.items()} # Mode average
best_words = ', '.join(sorted(dico_n.keys(), key=lambda x: dico_n[x], reverse=True)[:5])
js.hint_output.innerHTML = f'{len(dico_n)} mot(s) possible(s) dont: {best_words}'
`
  const py_guess = `
import numpy as np

# O = rien, 1 = bonne lettre mauvaise place, 2 = bonne lettre, bonne place
def compute_result(proposed_word, solution_word):
  result = [0] * len(proposed_word)
  prop_l, sol_l = list(proposed_word), list(solution_word)
  # Cherche les lettres bien placées
  for i, c in enumerate(prop_l):
    if c == sol_l[i]:
      result[i] = 2
      prop_l[i] = sol_l[i] = None

  # Parmi les lettres restantes, cherche les lettres mal placées
  for i, c in enumerate(prop_l):
    if c is not None and c in sol_l:
      sol_l.remove(c)
      result[i] = 1

  return result

def convert_result(result_list):
  result_int = [r * b for r, b in zip(result_list, base)]
  return sum(result_int)

def compute_entropy(dico_n):
  dico_values = np.array(list(dico_n.values()))
  dico_values = dico_values[dico_values!=0] / dico_values.sum()
  entropy = -(dico_values * np.log2(dico_values)).sum()
  return entropy

def distribution_possibilities(proposed_word, dico_n):
  distribution = np.zeros(3**(max_nb_chars+1))
  for solution_word, prob in dico_n.items():
    result = convert_result( compute_result(proposed_word, solution_word) )
    distribution[result] += prob
  # compute entropy
  distribution = distribution[distribution!=0] / distribution.sum()
  entropy = -(distribution * np.log2(distribution)).sum()
  return distribution, entropy

def expected_remaining_moves(dico_solutions, dico_admissible):
  total = sum([p for _,p in dico_solutions.items() if p > 0])
  current_entropy = compute_entropy(dico_solutions)
  print(f'   entropie = {current_entropy:.02f} bit')
  # js.document.getElementById("output").value = str(f'   entropie = {current_entropy:.02f} bit');
  # alert('entropie')
  if len(dico_solutions) * len(dico_admissible) > max_combinations_to_try:
    nb_words = max(min_words, max_combinations_to_try//len(dico_solutions))
    sorted_prob = sorted(dico_admissible.values(), reverse=True)
    dico_admissible = {w:p for w,p in dico_admissible.items() if p >= sorted_prob[nb_words]}
    print(f'   trop de mots à essayer, je teste les {len(dico_admissible)} plus populaires')  
  def estimator(w, p):
    p_normalized = p/total
    _, entropy = distribution_possibilities(w, dico_solutions)
    remaining_moves = round( (1-p_normalized) * (1.24+(current_entropy-entropy)*0.71) , 2)
    #return remaining_moves, current_entropy-entropy
    return remaining_moves

  entropy_list = [ (word, estimator(word, prob if word in dico_solutions else 0)) for word, prob in dico_admissible.items() ]
  entropy_list = sorted(entropy_list, key=lambda x: x[1])
  return entropy_list

def remove_based_on_result(dico_n, proposed_word, result_int):
  new_dico_n = {
    w: p for w, p in dico_n.items()
      if convert_result(compute_result(proposed_word, w)) == result_int
  }
  print(f'   taille du dictionnaire {len(dico_n)} --> {len(new_dico_n)}. Mots les plus populaires: {sorted(new_dico_n.keys(), key=lambda x: new_dico_n[x], reverse=True)[:5]}')
  return new_dico_n

def remove_based_on_first_letter(dico_n, c):
  new_dico_n = {
    w: p for w, p in dico_n.items() if w[0] == c
  }
  print(f'   taille du dictionnaire {len(dico_n)} -> {sorted(new_dico_n.keys(), key=lambda x: new_dico_n[x], reverse=True)[:5]}')
  return new_dico_n

def simulation(word_to_find, dico_n):
  dico_solutions = dico_n
  best_word_to_try = None
  while best_word_to_try != word_to_find:
    best_moves = expected_remaining_moves(dico_solutions, dico_n)
    best_word_to_try, nb_moves = best_moves[0]
    if len(best_moves) > 3:
      print(f'je tente "{best_word_to_try.upper()}" avec {nb_moves} coup(s) estimés, il y avait aussi {best_moves[1]} et {best_moves[2]}')
    else:
      print(f'je tente "{best_word_to_try.upper()}" avec {nb_moves} coup(s) estimés')
    #estimates.append(entropy)
    result = convert_result(compute_result(best_word_to_try, word_to_find))
    dico_solutions = remove_based_on_result(dico_solutions, best_word_to_try, result)

  # Archivage infos
  #for i, entropy in enumerate(estimates[::-1]):
  # archives.append( (entropy, i+1) )
  return 'finished'

def just_filter(dico_n):
  dico_solutions = dico_n
  trials  = [js.document.getElementById("try_"+str(i)).value for i in range(5)]
  results = js.results
  print(trials, results)
  message = ''

  # Digest user inputs
  i_last_word = -1
  for i, (word_trial, trial_result) in enumerate(zip(trials, results)):
    if len(word_trial) == int(js.n_total_char):
      print('Input used:', word_trial, trial_result)
      dico_solutions = remove_based_on_result(dico_solutions, word_trial, trial_result)
      i_last_word = i
    else:
      if len(word_trial) > 0 or trial_result > 0:
        print('Input not used:', word_trial, trial_result)
        message += f'Warning: input not used -> {word_trial} {trial_result}'
  message += f'{len(dico_solutions)} mot(s) possible(s) dont {sorted(dico_solutions.keys(), key=lambda x: dico_solutions[x], reverse=True)[:5]}'
  best_words = ', '.join(sorted(dico_solutions.keys(), key=lambda x: dico_solutions[x], reverse=True)[:5])
  js.hint_output.innerHTML = f'{len(dico_solutions)} mot(s) possible(s) dont: {best_words}'

  return message

def online_simulation(dico_n):
  dico_solutions = dico_n
  trials  = [js.document.getElementById("try_"+str(i)).value for i in range(5)]
  results = js.results
  print(trials, results)
  message = ''

  # Digest user inputs
  i_last_word = -1
  for i, (word_trial, trial_result) in enumerate(zip(trials, results)):
    if len(word_trial) == int(js.n_total_char):
      print('Input used:', word_trial, trial_result)
      dico_solutions = remove_based_on_result(dico_solutions, word_trial, trial_result)
      i_last_word = i
    else:
      if len(word_trial) > 0 or trial_result > 0:
        print('Input not used:', word_trial, trial_result)
        message += f'Warning: input not used -> {word_trial} {trial_result}'
  message += f'{len(dico_solutions)} mot(s) possible(s) dont {sorted(dico_solutions.keys(), key=lambda x: dico_solutions[x], reverse=True)[:5]}'
  best_words = ', '.join(sorted(dico_solutions.keys(), key=lambda x: dico_solutions[x], reverse=True)[:5])
  js.hint_output.innerHTML = f'{len(dico_solutions)} mot(s) possible(s) dont: {best_words}'

  # Now compute 
  best_moves = expected_remaining_moves(dico_solutions, dico_n)
  best_word_to_try, nb_moves = best_moves[0]

  # Display
  if len(best_moves) > 3:
    message += f' - je tente "{best_word_to_try.upper()}" avec {nb_moves} coup(s) estimés, il y avait aussi {best_moves[1]} et {best_moves[2]}'
  else:
    message += f' - je tente "{best_word_to_try.upper()}" avec {nb_moves} coup(s) estimés'

  js.document.getElementById("try_"+str(i_last_word+1)).value = best_word_to_try.lower()
  js.updateButtonsContent(i_last_word+1)
  return message

online_simulation(dico_n)
# just_filter(dico_n)
`
  // init Pyodide
  async function main() {
    let pyodide = await loadPyodide({ fullStdLib : false });
    await pyodide.runPythonAsync(py_init);
    output.value += "Loading numpy...\n";
    pyodide.loadPackage("numpy").then(() => {
      output.value += "Ready!\n";
      button_guess.setAttribute('class', "fluid ui primary massive button");
    });
    return pyodide;
  }

   async function changeLangPython() {
    button_guess.setAttribute('class', "fluid ui primary massive elastic loading button");
    let pyodide = await pyodideReadyPromise;
    await pyodide.runPythonAsync(py_load_lang);
    output.value += "New lang loaded...\n";
    button_guess.setAttribute('class', "fluid ui primary massive button");
  }

  async function guess() {
    button_guess.setAttribute('class', "fluid ui primary massive elastic loading button");
    let pyodide = await pyodideReadyPromise;
    let message = await pyodide.runPythonAsync(py_guess);
    addToOutput(message);
    button_guess.setAttribute('class', "fluid ui primary massive button");
  }

  output.value = "Initializing Pyodide...\n";
  button_guess.setAttribute('class', "fluid ui primary massive elastic loading button");
  let pyodideReadyPromise = main();
</script>
</body>
</html>