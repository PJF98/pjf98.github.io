<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@2.1.0/build/pure-min.css" integrity="sha384-yHIFVG6ClnONEA5yB5DJXfW2/KC173DIQrYoZMEtBvGzmf0PKiGyNEqe9N6BNDBH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@2.1.0/build/grids-responsive-min.css">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.0/full/pyodide.js"></script>
    <script>
      var results = new Array(0,0,0,0,0);
      function setColor(n_word, n_char) {
        var base = Math.pow(3, n_char);
        var current_state = Math.floor(results[n_word] / base) % 3;
        var property = document.getElementById('button_'+n_word+'_'+n_char);
        if (current_state == 0) {
          property.style.backgroundColor = "#ff9d00" // color if 1
          results[n_word] += base;
        } else if (current_state == 1) {
          property.style.backgroundColor = "#8fce00" // color if 2
          results[n_word] += base;
        } else {
          property.style.backgroundColor = "#999999" // color if 0
          results[n_word] -= 2*base;
        }
      }

      function updateButtons(n_word) {
        var input_word = document.getElementById('try_'+n_word).value;
        for (let c = 0; c < 9; c++) {
          var property = document.getElementById('button_'+n_word+'_'+c);
          property.value = (c < input_word.length) ? input_word.charAt(c) : '-'
        }
      }

      function setNbChars() {
        console.log('nbchar')
        n_char = document.getElementById('nbchars').value;
        console.log(n_char)
        for (let i_word = 0; i_word < 5; i_word++) {
          document.getElementById('try_'+i_word).setAttribute('maxlength', n_char);
          for (let i_char = 0; i_char < 9; i_char++) {
            document.getElementById('button_'+i_word+'_'+i_char).hidden = (i_char >= n_char);
          }
        }
      }
    </script>
  </head>

  <body>
    <div class="header">
      <h1>Wordle solver</h1>
      <h3>in French or in English</h3>
    </div>
    <div class="pure-g">
      <div class="pure-u-5-12 pure-u-md-1-4">
        <label>Try 1:</label>
        <input id="try_0" value="" oninput="updateButtons(0)" size="10" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" autofocus placeholder="1st guess"/>
      </div>
      <div class="pure-u-7-12 pure-u-md-1-2 pure-u-lg-1-3">
        <div class="pure-button-group">
          <input type="button" id="button_0_0" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(0, 0)";/>
          <input type="button" id="button_0_1" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(0, 1)";/>
          <input type="button" id="button_0_2" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(0, 2)";/>
          <input type="button" id="button_0_3" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(0, 3)";/>
          <input type="button" id="button_0_4" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(0, 4)";/>
          <input type="button" id="button_0_5" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(0, 5)";/>
          <input type="button" id="button_0_6" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(0, 6)";/>
          <input type="button" id="button_0_7" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(0, 7)";/>
          <input type="button" id="button_0_8" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(0, 8)";/>
        </div>
      </div>
      <br>
    </div>
    
    <div class="pure-g">
      <div class="pure-u-5-12 pure-u-md-1-4">
        <label>Try 2:</label>
        <input id="try_1" value="" oninput="updateButtons(1)" size="9" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      </div>
      <div class="pure-u-7-12 pure-u-md-1-2 pure-u-lg-1-3">
        <div class="pure-button-group">
          <input type="button" id="button_1_0" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(1, 0)";/>
          <input type="button" id="button_1_1" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(1, 1)";/>
          <input type="button" id="button_1_2" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(1, 2)";/>
          <input type="button" id="button_1_3" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(1, 3)";/>
          <input type="button" id="button_1_4" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(1, 4)";/>
          <input type="button" id="button_1_5" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(1, 5)";/>
          <input type="button" id="button_1_6" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(1, 6)";/>
          <input type="button" id="button_1_7" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(1, 7)";/>
          <input type="button" id="button_1_8" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(1, 8)";/>
        </div>
      </div>
    <br>
    </div>

    <div class="pure-g">
      <div class="pure-u-5-12 pure-u-md-1-4">
        <label>Try 3:</label>
        <input id="try_2" value="" oninput="updateButtons(2)" size="9" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      </div>
      <div class="pure-u-7-12 pure-u-md-1-2 pure-u-lg-1-3">
        <div class="pure-button-group">
          <input type="button" id="button_2_0" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(2, 0)";/>
          <input type="button" id="button_2_1" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(2, 1)";/>
          <input type="button" id="button_2_2" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(2, 2)";/>
          <input type="button" id="button_2_3" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(2, 3)";/>
          <input type="button" id="button_2_4" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(2, 4)";/>
          <input type="button" id="button_2_5" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(2, 5)";/>
          <input type="button" id="button_2_6" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(2, 6)";/>
          <input type="button" id="button_2_7" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(2, 7)";/>
          <input type="button" id="button_2_8" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(2, 8)";/>
        </div>
      </div>
    <br>
    </div>

    <div class="pure-g">
      <div class="pure-u-5-12 pure-u-md-1-4">
        <label>Try 4:</label>
        <input id="try_3" value="" oninput="updateButtons(3)" size="9" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      </div>
      <div class="pure-u-7-12 pure-u-md-1-2 pure-u-lg-1-3">
        <div class="pure-button-group">
          <input type="button" id="button_3_0" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(3, 0)";/>
          <input type="button" id="button_3_1" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(3, 1)";/>
          <input type="button" id="button_3_2" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(3, 2)";/>
          <input type="button" id="button_3_3" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(3, 3)";/>
          <input type="button" id="button_3_4" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(3, 4)";/>
          <input type="button" id="button_3_5" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(3, 5)";/>
          <input type="button" id="button_3_6" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(3, 6)";/>
          <input type="button" id="button_3_7" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(3, 7)";/>
          <input type="button" id="button_3_8" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(3, 8)";/>
        </div>
      </div>
    <br>
    </div>

    <div class="pure-g">
      <div class="pure-u-5-12 pure-u-md-1-4">
        <label>Try 5:</label>
        <input id="try_4" value="" oninput="updateButtons(4)" size="9" maxlength="5" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      </div>
      <div class="pure-u-7-12 pure-u-md-1-2 pure-u-lg-1-3">
        <div class="pure-button-group">
          <input type="button" id="button_4_0" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(4, 0)";/>
          <input type="button" id="button_4_1" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(4, 1)";/>
          <input type="button" id="button_4_2" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(4, 2)";/>
          <input type="button" id="button_4_3" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(4, 3)";/>
          <input type="button" id="button_4_4" value="-" class="pure-button" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(4, 4)";/>
          <input type="button" id="button_4_5" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(4, 5)";/>
          <input type="button" id="button_4_6" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(4, 6)";/>
          <input type="button" id="button_4_7" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(4, 7)";/>
          <input type="button" id="button_4_8" value="-" class="pure-button" hidden="true" style="background:#999999;color:white;font-size: 150%;width:3em;" onclick="setColor(4, 8)";/>
        </div>
      </div>
    <br>
    </div>
    <button onclick="evaluatePython()" class="pure-button pure-button-primary" style="font-size: 200%;">Guess</button>
    <button onclick="changeLangPython()" class="pure-button" id="changelang" style="font-size: 200%;">FR</button>
    <select onchange="setNbChars()" id="nbchars" style="font-size: 200%;">
      <option>2</option>
      <option>3</option>
      <option>4</option>
      <option selected>5</option>
      <option>6</option>
      <option>7</option>
      <option>8</option>
      <option>9</option>
    </select>

    <br>
    <div>Output:</div>
    <div class="pure-g">
      <div class="pure-u-1-1 pure-u-md-3-4 pure-u-lg-1-2">
        <textarea id="output" style="width: 90%;" rows="10" disabled></textarea>
      </div>
    </div>

    <script>
      const output = document.getElementById("output");


      function addToOutput(s) {
        output.value += ">>>" + s + "\n";
      }

      output.value = "Initializing Pyodide...\n";
      // init Pyodide
      async function main() {
        let pyodide = await loadPyodide({ fullStdLib : false });
        await pyodide.runPythonAsync(`
from pyodide.http import pyfetch
from math import log2, sqrt

max_nb_chars = 10
base = [3**i for i in range(max_nb_chars+1)]
max_combinations_to_try = 200000
min_words = 20
default_freq = 0.001

estimates = []
archives = []


json_url = 'https://raw.githubusercontent.com/cestpasphoto/wordle_solver_french/main/parsed_fr_dictionary.json'
dico_lang = 'fr'
response = await pyfetch(json_url)
dico = await (response.json())
dico_n = dico[5]
dico_n = {w: p for w,p in dico_n.items() if p >= 0.001} # Mode "top"
dico_n = {w: sqrt(p) for w,p in dico_n.items()} # Mode average
        `)
        output.value += "Loading numpy...\n";
        pyodide.loadPackage("numpy").then(() => {
          output.value += "Ready!\n";
        });
        return pyodide;
      }
      let pyodideReadyPromise = main();

      async function changeLangPython() {
        let pyodide = await pyodideReadyPromise;
        await pyodide.runPythonAsync(`
from pyodide.http import pyfetch
from math import log2, sqrt
import js
json_fr = 'https://raw.githubusercontent.com/cestpasphoto/wordle_solver_french/main/parsed_fr_dictionary.json'
json_en = 'https://raw.githubusercontent.com/cestpasphoto/wordle_solver_french/main/parsed_en_dictionary.json'

if dico_lang == 'fr':
  json_url = json_en
  dico_lang = 'en'
else:
  json_url = json_fr
  dico_lang = 'fr'
n_chars = int(js.document.getElementById('nbchars').value);
response = await pyfetch(json_url)
dico = await (response.json())
dico_n = dico[n_chars]
dico_n = {w: p for w,p in dico_n.items() if p >= 0.001} # Mode "top"
dico_n = {w: sqrt(p) for w,p in dico_n.items()} # Mode average
js.document.getElementById("changelang").innerHTML = dico_lang.upper()
print(n_chars, ': ', len(dico_n))
        `);
        output.value += "New lang loaded...\n";
      };

      async function evaluatePython() {
        let pyodide = await pyodideReadyPromise;
        addToOutput(pyodide.runPython(`
import numpy as np
import js

# O = rien, 1 = bonne lettre mauvaise place, 2 = bonne lettre, bonne place
def compute_result(proposed_word, solution_word):
  result = [0] * len(proposed_word)
  prop_l, sol_l = list(proposed_word), list(solution_word)
  # Cherche les lettres bien placées
  for i, c in enumerate(prop_l):
    if c == sol_l[i]:
      result[i] = 2
      prop_l[i] = sol_l[i] = None

  # Parmi les lettres restantes, cherche les lettres mal placées
  for i, c in enumerate(prop_l):
    if c is not None and c in sol_l:
      sol_l.remove(c)
      result[i] = 1

  return result

def convert_result(result_list):
  result_int = [r * b for r, b in zip(result_list, base)]
  return sum(result_int)

def compute_entropy(dico_n):
  dico_values = np.array(list(dico_n.values()))
  dico_values = dico_values[dico_values!=0] / dico_values.sum()
  entropy = -(dico_values * np.log2(dico_values)).sum()
  return entropy

def distribution_possibilities(proposed_word, dico_n):
  distribution = np.zeros(3**(max_nb_chars+1))
  for solution_word, prob in dico_n.items():
    result = convert_result( compute_result(proposed_word, solution_word) )
    distribution[result] += prob
  # compute entropy
  distribution = distribution[distribution!=0] / distribution.sum()
  entropy = -(distribution * np.log2(distribution)).sum()
  return distribution, entropy

def expected_remaining_moves(dico_solutions, dico_admissible):
  total = sum([p for _,p in dico_solutions.items() if p > 0])
  current_entropy = compute_entropy(dico_solutions)
  print(f'   entropie = {current_entropy:.02f} bit')
  # js.document.getElementById("output").value = str(f'   entropie = {current_entropy:.02f} bit');
  # alert('entropie')
  if len(dico_solutions) * len(dico_admissible) > max_combinations_to_try:
    nb_words = max(min_words, max_combinations_to_try//len(dico_solutions))
    sorted_prob = sorted(dico_admissible.values(), reverse=True)
    dico_admissible = {w:p for w,p in dico_admissible.items() if p >= sorted_prob[nb_words]}
    print(f'   trop de mots à essayer, je teste les {len(dico_admissible)} plus populaires')  
  def estimator(w, p):
    p_normalized = p/total
    _, entropy = distribution_possibilities(w, dico_solutions)
    remaining_moves = round( (1-p_normalized) * (1.24+(current_entropy-entropy)*0.71) , 2)
    #return remaining_moves, current_entropy-entropy
    return remaining_moves

  entropy_list = [ (word, estimator(word, prob if word in dico_solutions else 0)) for word, prob in dico_admissible.items() ]
  entropy_list = sorted(entropy_list, key=lambda x: x[1])
  return entropy_list

def remove_based_on_result(dico_n, proposed_word, result_int):
  new_dico_n = {
    w: p for w, p in dico_n.items()
      if convert_result(compute_result(proposed_word, w)) == result_int
  }
  print(f'   taille du dictionnaire {len(dico_n)} --> {len(new_dico_n)}. Mots les plus populaires: {sorted(new_dico_n.keys(), key=lambda x: new_dico_n[x], reverse=True)[:5]}')
  return new_dico_n

def remove_based_on_first_letter(dico_n, c):
  new_dico_n = {
    w: p for w, p in dico_n.items() if w[0] == c
  }
  print(f'   taille du dictionnaire {len(dico_n)} -> {sorted(new_dico_n.keys(), key=lambda x: new_dico_n[x], reverse=True)[:5]}')
  return new_dico_n

def simulation(word_to_find, dico_n):
  dico_solutions = dico_n
  best_word_to_try = None
  while best_word_to_try != word_to_find:
    best_moves = expected_remaining_moves(dico_solutions, dico_n)
    best_word_to_try, nb_moves = best_moves[0]
    if len(best_moves) > 3:
      print(f'je tente "{best_word_to_try.upper()}" avec {nb_moves} coup(s) estimés, il y avait aussi {best_moves[1]} et {best_moves[2]}')
    else:
      print(f'je tente "{best_word_to_try.upper()}" avec {nb_moves} coup(s) estimés')
    #estimates.append(entropy)
    result = convert_result(compute_result(best_word_to_try, word_to_find))
    dico_solutions = remove_based_on_result(dico_solutions, best_word_to_try, result)

  # Archivage infos
  #for i, entropy in enumerate(estimates[::-1]):
  # archives.append( (entropy, i+1) )
  return 'finished'

def online_simulation(dico_n):
  dico_solutions = dico_n
  trials  = [js.document.getElementById("try_"+str(i)).value for i in range(5)]
  results = js.results
  message = ''

  # Digest user inputs
  i_last_word = -1
  for i, (word_trial, trial_result) in enumerate(zip(trials, results)):
    if len(word_trial) == int(js.document.getElementById('nbchars').value):
      print('Input used:', word_trial, trial_result)
      dico_solutions = remove_based_on_result(dico_solutions, word_trial, trial_result)
      i_last_word = i
    else:
      if len(word_trial) > 0 or trial_result > 0:
        print('Input not used:', word_trial, trial_result)
        message += f'Warning: input not used -> {word_trial} {trial_result}'
  message += f'{len(dico_solutions)} mot(s) possible(s) dont {sorted(dico_solutions.keys(), key=lambda x: dico_solutions[x], reverse=True)[:5]}'

  # Now compute 
  best_moves = expected_remaining_moves(dico_solutions, dico_n)
  best_word_to_try, nb_moves = best_moves[0]

  # Display
  if len(best_moves) > 3:
    message += f' - je tente "{best_word_to_try.upper()}" avec {nb_moves} coup(s) estimés, il y avait aussi {best_moves[1]} et {best_moves[2]}'
  else:
    message += f' - je tente "{best_word_to_try.upper()}" avec {nb_moves} coup(s) estimés'

  js.document.getElementById("try_"+str(i_last_word+1)).value = best_word_to_try.lower()
  js.updateButtons(i_last_word+1)
  return message

online_simulation(dico_n)
        `));
      }
    </script>
  </body>
</html>